"use strict";var indexOf=[].indexOf||function(e){for(var t=0,a=this.length;t<a;t++)if(t in this&&this[t]===e)return t;return-1};angular.module("admin").directive("datepicker",["$rootScope","$state","$locale","$location","$filter","$modal","datePickerUtils","lessonService","bookService","unitService","courseService","coursewareService",function(e,t,a,n,s,d,i,r,c,o,l,u){return{require:"ngModel",restrict:"EA",scope:{date:"=ngModel",grade:"=",status:"=",onSelect:"&",weekStartsOn:"=",noExtraRows:"="},template:'<div class="pickadate-top"></div><div class="pickadate-header"><div class="special"><button ng-click="prevMonth()" class="btn btn-primary">上一个月</button></div><div class="special"><h3 class="pickadate-centered-heading">{{yearMonth}}</h3></div><div class="special"><button ng-click="nextMonth()" class="btn btn-primary">下一个月</button></div></div><div class="pickadate-weeks"><div class="pickadate-week" ng-repeat="week in dayName">{{week}}</div></div><div class="pickadate-body"><div class="pickadate-main"><ul class="pickadate-cell"><li bindonce ng-repeat="d in dates" ng-click="showModal(d)"><div class="{{d.className}}" ><b>{{d.dateObj | date:"d"}}</b><span class="ellipsis margin-bottom-5">{{d.data.uname}}</span><p class="ellipsis">{{d.data.wname}}</p></div></li></ul></div></div>',link:function(t,a,n,c){function o(e){return/pickadate-disabled/.test(e.className)}function m(e){t.dates={};for(var a=new Date(new Date(e).getFullYear(),new Date(e).getMonth(),1,3),n=a.getMonth()+1,d=i.buildDates(a,{weekStartsOn:v,noExtraRows:!0}),r=[],c=0;c<d.length;c++){var o="pickadate-enabled",l=d[c],u=s("date")(l,"yyyy-MM-dd");s("date")(l,"M")!==n.toString()&&(o="pickadate-hide pickadate-disabled"),u===f&&s("date")(l,"M")===n.toString()&&(o="pickadate-active"),r.push({date:u,dateObj:l,className:o})}t.dates=r}function h(){var e=t.yearMonth.split("-")[0],a=t.yearMonth.split("-")[1]-1,n={startAt:new Date(e,a,1,0).getTime(),endAt:new Date(e,a,i.getMonthDate(e,a),23,59,59).getTime(),grade:t.grade,size:32,status:1};r.getList(n).then(function(e){return 0===e.data.code&&void angular.forEach(e.data.data,function(e,a){var n=s("date")(e.startAt,"yyyy-MM-dd");angular.forEach(t.dates,function(t,a){t.date===n&&angular.extend(t,{data:e})})})})}function p(){var a={grade:t.grade,status:1,size:65535};u.getList(a).then(function(a){0===a.data.code?t.cwareList=a.data.data.list:e.alert(a.data.message)})}function g(){var a={grade:t.grade,status:1,size:65535};l.getList(a).then(function(a){0===a.data.code?t.courseList=a.data.data:e.alert(a.data.message)})}function y(e){r.get(e).then(function(e){0===e.data.code&&(t.params.cid=e.data.data.cid,t.params.wid=e.data.data.wid)})}var v=t.weekStartsOn||0,f=(n.hasOwnProperty("noExtraRows"),s("date")(new Date,"yyyy-MM-dd"));(!angular.isNumber(v)||v<0||v>6)&&(v=0),t.dayName=i.buildDayNames(v),t.yearMonth=s("date")(new Date,"yyyy-MM"),t.render=function(){m(t.yearMonth)},h(),p(),g(),console.log(e.globalPermission),t.setDate=function(e,a){o(e)||(c.$setViewValue(e.date),t.selectedDate=e.date,angular.forEach(t.dates,function(a,n){for(var s=0,d=t.dates[n].length;s<d;s++)"pickadate-selected"==t.dates[n][s].className&&(t.dates[n][s].className="pickadate-enabled"),t.dates[n][s].date==f&&(t.dates[n][s].className="pickadate-active"),t.dates[n][s].date==e.date&&e.date.indexOf(n)>-1&&(t.dates[n][s].className="pickadate-selected")}),t.onSelect())},t.showModal=function(a){console.log(a),t.cwarePage.isPrev(),t.cwarePage.isNext(),console.log(e.globalPermission),t.Permission=e.globalPermission,console.log(t.Permission),t.params={},t.selectedItem=a;var n="";t.selectedItem.data?(n="编辑课程",y(t.selectedItem.data.id),t.params.id=t.selectedItem.data.id,t.lessonstart=new Date(parseInt(t.selectedItem.data.startAt)),t.lessonend=new Date(parseInt(t.selectedItem.data.endAt))):n="新增课程",t.myModal=d({scope:t,templateUrl:"views/template/lesson-modal.html",title:n,show:!1}),t.myModal.$promise.then(t.myModal.show)},t.prevMonth=function(){var e=new Date(new Date(t.yearMonth).getFullYear(),new Date(t.yearMonth).getMonth()-1,1,3);t.yearMonth=s("date")(e,"yyyy-MM"),m(t.yearMonth),h()},t.nextMonth=function(){var e=new Date(new Date(t.yearMonth).getFullYear(),new Date(t.yearMonth).getMonth()+1,1,3);t.yearMonth=s("date")(e,"yyyy-MM"),m(t.yearMonth),h()},c.$render=function(){t.render()},t.cwarePage={defaultLength:9,total:function(){return t.cwareList?t.cwareList.length:0},current:1,nextDisabled:!0,prevDisabled:!0,isNext:function(){this.nextDisabled=this.total()<=this.defaultLength*this.current},isPrev:function(){this.prevDisabled=this.current<=1},showNext:function(){this.current++,this.isNext(),this.isPrev()},showPrev:function(){this.current--,this.isNext(),this.isPrev()}},t.cwareListRange=function(){var e=t.cwarePage.defaultLength*(t.cwarePage.current-1),a=e+t.cwarePage.defaultLength;return t.cwareList.slice(e,a)},t.cwareSelect=function(e){e&&(t.params.wid=e.id)},t.selectAction=function(e){e&&(t.params.cid=parseInt(e))},t.submitLesson=function(a,n){t.params.startAt=i.getDateByTime(t.selectedItem.date,a),t.params.endAt=i.getDateByTime(t.selectedItem.date,n),t.params.status=1,t.params.startAt<t.params.endAt?t.selectedItem.data?r.update(t.params.id,t.params).then(function(a){0===a.data.code?(e.alert("更新信息成功",t.myModal.$promise.then(t.myModal.hide)),h()):e.alert(a.data.message)}):r.add(t.params).then(function(a){0===a.data.code?(e.alert("增加信息成功",t.myModal.$promise.then(t.myModal.hide)),h()):e.alert(a.data.message)}):e.alert("开始时间不能大于结束时间")},t.del=function(){r.del(t.params.id).then(function(a){0===a.data.code&&e.alert("删除信息成功",function(){t.myModal.$promise.then(t.myModal.hide),h(),t.render()})})}}}}]);