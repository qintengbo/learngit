angular.module("admin").controller("eventDetailController",["$scope","$rootScope","$state","parameterService","FileUploader","uploadService","$timeout",function(t,e,i,a,r,n,l){function s(){a.getRedSet({page:1,size:9999}).error(function(){}).then(function(t){0==t.data.code?angular.forEach(t.data.data,function(t){2==t.status&&t.endAt>e.nowDate&&o.redList.push(t)}):e.alert(t.data.message)})}var o=this;o.params={},o.id=i.params.id,o.params.type=3,o.redList=[],o.prize=[{type:"1",content:""},{type:"2",content:""},{type:"3",list:[{id:"",counts:""}]}],s(),o.id?(a.putArticleDetail(o.id).then(function(t){if(0===t.data.code){o.params=t.data.data.article;var i=JSON.parse(t.data.data.article.prize);angular.forEach(i,function(t){angular.forEach(o.prize,function(e){t.type==e.type&&3!=e.type?e.content=t.content:3==e.type&&(t.list?e.list=t.list:e.list=[{id:"",counts:""}])})})}else e.alert(t.data.message)}),o.adviertisementAdd=function(t){if(t)o.error=!0,l(function(){o.error=!1},3e3);else{for(var r=angular.copy(o.prize),n=0;n<r.length;++n)if(""==r[n].content&&3!=r[n].type)r.splice(n,1),n-=1;else if(3==r[n].type){for(var s=0;s<r[n].list.length;s++){if(r[n].list[s].id&&(!r[n].list[s].counts||null==r[n].list[s].counts))return e.alert("请填写红包个数"),!1;if(r[n].list[s].counts&&(!r[n].list[s].id||null==r[n].list[s].id))return e.alert("请选择红包种类"),!1;""!=r[n].list[s].counts&&""!=r[n].list[s].id||r[n].list.splice(s,1)}0==r[n].list.length&&r.splice(n,1)}if(!r||0==r.length)return e.alert("请至少填写一种奖品"),!1;o.params.prize=JSON.stringify(r),a.putArticle(o.id,o.params).then(function(t){0===t.data.code?e.alert("修改成功",i.go("field.eventSet",{},{reload:!0})):e.alert(t.data.message)})}}):o.adviertisementAdd=function(t){if(t)o.error=!0,l(function(){o.error=!1},3e3);else{for(var r=angular.copy(o.prize),n=0;n<r.length;++n)if(""==r[n].content&&3!=r[n].type)r.splice(n,1),n-=1;else if(3==r[n].type){for(var s=0;s<r[n].list.length;s++){if(r[n].list[s].id&&(!r[n].list[s].counts||null==r[n].list[s].counts))return e.alert("请填写红包个数"),!1;if(r[n].list[s].counts&&(!r[n].list[s].id||null==r[n].list[s].id))return e.alert("请选择红包种类"),!1;""!=r[n].list[s].counts&&""!=r[n].list[s].id||r[n].list.splice(s,1)}0==r[n].list.length&&r.splice(n,1)}if(!r||0==r.length)return e.alert("请至少填写一种奖品"),!1;o.params.endAt&&(o.params.endAt=parseInt(o.params.endAt)+864e5-1),o.params.prize=JSON.stringify(r),a.addArticle(o.params).then(function(t){0===t.data.code?e.alert("添加成功",i.go("field.eventSet",{},{reload:!0})):e.alert(t.data.message)})}},r.FileSelect.prototype.isEmptyAfterSelection=function(){return!0},o.uploader=new r({}),o.uploader=n.uploadFile(r),o.uploader.onSuccessItem=function(t,e,i,a){200==i&&(o.params.img=e.data.url)},o.text=function(t){var e=o.prize[2].list,i=e.length;return t==i-1?"+添加":" 删除 "},o.addlist=function(t){var i=o.prize[2].list,a=i.length;t==a-1?angular.forEach(i,function(t){""==t.counts||""==t.id?e.alert("请先将先前添加的红包填写完成再进行添加"):i.push({})}):i.splice(t,1)}}]);